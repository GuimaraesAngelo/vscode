# Phase 4: Admin, Observability & Intelligence

This document defines the architecture for the administrative and analytical components of the Agents First IDE.

## 1. Agents Manager Panel
**Goal**: Provide a UI to configure the behavior of the specialized agents.

### UI Structure
- **Sidebar/List**: Displays all agents (Copilot, Architect, Implementer, Tester).
- **Detail View**:
    - **Identity**: Name, Role, Avatar.
    - **Model Config**: Dropdown for `gpt-4-turbo`, `gpt-4o`, `o1-preview`.
    - **System Instructions**: Large text area to edit the prompt.
    - **Tools**: List of registered tools with Toggle switches (Enable/Disable).
    - **Stats**: Mini-dashboard (Total Runs, Success Rate).

### Data Interaction
- **Read**: `prisma.agent.findMany({ include: { tools: true } })`
- **Update**:
    - Update Agent: `prisma.agent.update(...)`
    - Toggle Tool: `prisma.agentTool.upsert(...)`

## 2. Observability Panel
**Goal**: Visualize system performance and costs.

### Metrics
1.  **Global Stats**:
    - Total Runs (Count of `Run` table).
    - Total Cost (Sum of `Run.cost`).
    - Avg Latency (Avg of `Run.completedAt - Run.startedAt`).
2.  **Agent Performance**:
    - Table: Agent Name | Runs | Success % | Avg Cost.
3.  **Tool Usage**:
    - Chart/List: Top tools by invocation count.
    - Error Rate: % of `ToolCall` where `status == 'error'`.

### Data Interaction
- **Aggregations**:
    - `prisma.run.groupBy({ by: ['agentId'], _count: true, _avg: { cost: true } })`
    - `prisma.toolCall.groupBy({ by: ['toolName'], _count: true })`

## 3. Project Intelligence Panel
**Goal**: Static analysis and insights about the workspace.

### Features
- **Tech Stack**: Detect languages and frameworks (e.g., via `package.json`, file extensions).
- **Health Check**: Lint errors, test coverage (if available).
- **Architecture Map**: Textual description generated by the Architect agent.

### Implementation
- **Service**: `ProjectIntelligenceService`.
- **Storage**: In-memory cache or `Setting` table for "last_analysis".

## 4. Configuration & Security
**Goal**: Workspace-specific settings and safety rails.

### File Structure
`.vscode/agents-first/`
- `settings.json`:
    ```json
    {
      "security": {
        "allow_terminal": ["npm test", "ls"],
        "max_patch_lines": 500
      },
      "models": {
        "implementer": "gpt-4o"
      }
    }
    ```

### Enforcement
- **AgentRunner**:
    - Load settings on start.
    - Check `security.allow_terminal` before executing `run_command`.
    - Check `max_patch_lines` before `apply_patch`.

## 5. Prisma Schema Mapping
No new tables are strictly required for the MVP of Phase 4, as `Setting` can store generic configs and `Agent`/`Run` cover the rest.
However, for **Project Intelligence**, we might eventually want a `ProjectSnapshot` table, but we will start with on-demand analysis.

## 6. Implementation Plan
1.  **Agents Manager**: `src/ui/AgentsManager/` (Webview).
2.  **Observability**: `src/ui/Observability/` (Webview or Tab in Agents Manager).
3.  **Services**: `src/services/admin.ts`, `src/services/observability.ts`.
4.  **Security Middleware**: Update `AgentRunner` and Tools.
